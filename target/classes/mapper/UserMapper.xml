<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cloudfitness.mapper.UserMapper">
    
    <resultMap id="BaseResultMap" type="com.cloudfitness.entity.User">
        <id column="user_id" property="userId"/>
        <result column="username" property="username"/>
        <result column="password" property="password"/>
        <result column="email" property="email"/>
        <result column="phone_number" property="phoneNumber"/>
        <result column="role" property="role"/>
        <result column="status" property="status"/>
        <result column="last_login_time" property="lastLoginTime"/>
        <result column="registration_date" property="registrationDate"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="description" property="description"/>
        <result column="openid" property="openid"/>
    </resultMap>

    <select id="selectByUsername" resultMap="BaseResultMap">
        SELECT * FROM users WHERE username = #{username}
    </select>

    <select id="selectByPhoneNumber" resultMap="BaseResultMap">
        SELECT * FROM users WHERE phone_number = #{phoneNumber}
    </select>

    <select id="selectByEmail" resultMap="BaseResultMap">
        SELECT * FROM users WHERE email = #{email}
    </select>

    <select id="selectMembers" resultMap="BaseResultMap">
        SELECT u.* FROM users u
        LEFT JOIN memberships m ON u.user_id = m.user_id
        WHERE u.role = 'member'
        <if test="username != null and username != ''">
            AND u.username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="phoneNumber != null and phoneNumber != ''">
            AND u.phone_number LIKE CONCAT('%', #{phoneNumber}, '%')
        </if>
        <if test="email != null and email != ''">
            AND u.email LIKE CONCAT('%', #{email}, '%')
        </if>
        <if test="startDate != null and startDate != ''">
            AND DATE(u.registration_date) &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND DATE(u.registration_date) &lt;= #{endDate}
        </if>
        <if test="membershipStatus != null and membershipStatus != ''">
            <choose>
                <when test="membershipStatus == 'valid'">
                    AND m.expiry_date &gt;= NOW()
                </when>
                <when test="membershipStatus == 'expired'">
                    AND (m.expiry_date &lt; NOW() OR m.expiry_date IS NULL)
                </when>
            </choose>
        </if>
        ORDER BY u.registration_date DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="countMembers" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT u.user_id) FROM users u
        LEFT JOIN memberships m ON u.user_id = m.user_id
        WHERE u.role = 'member'
        <if test="username != null and username != ''">
            AND u.username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="phoneNumber != null and phoneNumber != ''">
            AND u.phone_number LIKE CONCAT('%', #{phoneNumber}, '%')
        </if>
        <if test="email != null and email != ''">
            AND u.email LIKE CONCAT('%', #{email}, '%')
        </if>
        <if test="startDate != null and startDate != ''">
            AND DATE(u.registration_date) &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND DATE(u.registration_date) &lt;= #{endDate}
        </if>
        <if test="membershipStatus != null and membershipStatus != ''">
            <choose>
                <when test="membershipStatus == 'valid'">
                    AND m.expiry_date &gt;= NOW()
                </when>
                <when test="membershipStatus == 'expired'">
                    AND (m.expiry_date &lt; NOW() OR m.expiry_date IS NULL)
                </when>
            </choose>
        </if>
    </select>

    <select id="selectCoaches" resultMap="BaseResultMap">
        SELECT * FROM users
        WHERE role = 'coach'
        <if test="username != null and username != ''">
            AND username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="phoneNumber != null and phoneNumber != ''">
            AND phone_number LIKE CONCAT('%', #{phoneNumber}, '%')
        </if>
        <if test="startDate != null and startDate != ''">
            AND DATE(registration_date) &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND DATE(registration_date) &lt;= #{endDate}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        ORDER BY registration_date DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="countCoaches" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM users
        WHERE role = 'coach'
        <if test="username != null and username != ''">
            AND username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="phoneNumber != null and phoneNumber != ''">
            AND phone_number LIKE CONCAT('%', #{phoneNumber}, '%')
        </if>
        <if test="startDate != null and startDate != ''">
            AND DATE(registration_date) &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND DATE(registration_date) &lt;= #{endDate}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
    </select>

    <select id="selectAdmins" resultMap="BaseResultMap">
        SELECT * FROM users
        WHERE role = 'admin'
        <if test="username != null and username != ''">
            AND username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="phoneNumber != null and phoneNumber != ''">
            AND phone_number LIKE CONCAT('%', #{phoneNumber}, '%')
        </if>
        <if test="startDate != null and startDate != ''">
            AND DATE(registration_date) &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND DATE(registration_date) &lt;= #{endDate}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        ORDER BY registration_date DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="countAdmins" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM users
        WHERE role = 'admin'
        <if test="username != null and username != ''">
            AND username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="phoneNumber != null and phoneNumber != ''">
            AND phone_number LIKE CONCAT('%', #{phoneNumber}, '%')
        </if>
        <if test="startDate != null and startDate != ''">
            AND DATE(registration_date) &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND DATE(registration_date) &lt;= #{endDate}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
    </select>

    <select id="selectByOpenid" resultMap="BaseResultMap">
        SELECT * FROM users WHERE openid = #{openid}
    </select>

</mapper>

