<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cloudfitness.mapper.AttendanceMapper">
    
    <resultMap id="BaseResultMap" type="com.cloudfitness.entity.Attendance">
        <id column="attendance_id" property="attendanceId"/>
        <result column="reservation_id" property="reservationId"/>
        <result column="check_in_time" property="checkInTime"/>
        <result column="is_on_time" property="isOnTime"/>
        <result column="late_minutes" property="lateMinutes"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <select id="selectByReservationId" resultMap="BaseResultMap">
        SELECT * FROM attendance
        WHERE reservation_id = #{reservationId}
        LIMIT 1
    </select>

    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT a.* FROM attendance a
        INNER JOIN reservations r ON a.reservation_id = r.reservation_id
        WHERE r.user_id = #{userId}
        <if test="month != null and month != ''">
            AND DATE_FORMAT(a.check_in_time, '%Y-%m') = #{month}
        </if>
        ORDER BY a.check_in_time DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <select id="selectAdminAttendance" resultMap="BaseResultMap">
        SELECT a.* FROM attendance a
        INNER JOIN reservations r ON a.reservation_id = r.reservation_id
        WHERE 1=1
        <if test="userId != null">
            AND r.user_id = #{userId}
        </if>
        <if test="courseId != null">
            AND r.course_id = #{courseId}
        </if>
        <if test="startDate != null and startDate != ''">
            AND DATE(a.check_in_time) &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND DATE(a.check_in_time) &lt;= #{endDate}
        </if>
        <if test="isOnTime != null">
            AND a.is_on_time = #{isOnTime}
        </if>
        ORDER BY a.check_in_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="countAdminAttendance" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM attendance a
        INNER JOIN reservations r ON a.reservation_id = r.reservation_id
        WHERE 1=1
        <if test="userId != null">
            AND r.user_id = #{userId}
        </if>
        <if test="courseId != null">
            AND r.course_id = #{courseId}
        </if>
        <if test="startDate != null and startDate != ''">
            AND DATE(a.check_in_time) &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND DATE(a.check_in_time) &lt;= #{endDate}
        </if>
        <if test="isOnTime != null">
            AND a.is_on_time = #{isOnTime}
        </if>
    </select>

</mapper>


