{"version":3,"file":"upload.js","sources":["utils/upload.js"],"sourcesContent":["// 图片上传工具\r\nexport const chooseImage = () => {\r\n  return new Promise((resolve, reject) => {\r\n    uni.chooseImage({\r\n      count: 1,\r\n      sizeType: ['compressed'],\r\n      sourceType: ['album', 'camera'],\r\n      success: (res) => {\r\n        resolve(res.tempFilePaths[0])\r\n      },\r\n      fail: (err) => {\r\n        reject(err)\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\n// 保存图片到本地\r\nexport const saveImageToLocal = (tempFilePath, fileName) => {\r\n  return new Promise((resolve, reject) => {\r\n    // 小程序环境使用 uni.saveFile 保存文件\r\n    // #ifdef MP-WEIXIN || MP-ALIPAY || MP-BAIDU || MP-TOUTIAO || MP-QQ\r\n    uni.saveFile({\r\n      tempFilePath: tempFilePath,\r\n      success: (res) => {\r\n        // 保存成功，返回保存的文件路径\r\n        const savedFilePath = res.savedFilePath\r\n        resolve(savedFilePath)\r\n      },\r\n      fail: (err) => {\r\n        // 如果保存失败，尝试使用 base64\r\n        saveAsBase64(tempFilePath, fileName).then(resolve).catch(reject)\r\n      }\r\n    })\r\n    // #endif\r\n    \r\n    // #ifndef MP-WEIXIN || MP-ALIPAY || MP-BAIDU || MP-TOUTIAO || MP-QQ\r\n    // 其他平台使用 base64 存储\r\n    saveAsBase64(tempFilePath, fileName).then(resolve).catch(reject)\r\n    // #endif\r\n  })\r\n}\r\n\r\n// 保存为 base64\r\nconst saveAsBase64 = (tempFilePath, fileName) => {\r\n  return new Promise((resolve, reject) => {\r\n    const fs = uni.getFileSystemManager()\r\n    fs.readFile({\r\n      filePath: tempFilePath,\r\n      encoding: 'base64',\r\n      success: (res) => {\r\n        const base64Data = `data:image/jpeg;base64,${res.data}`\r\n        // 保存到本地存储\r\n        uni.setStorageSync(`avatar_base64_${fileName}`, base64Data)\r\n        resolve(base64Data)\r\n      },\r\n      fail: (err) => {\r\n        reject(err)\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\n// 获取本地头像路径\r\nexport const getAvatarPath = (userId) => {\r\n  if (!userId) return null\r\n  \r\n  // 先从本地存储获取路径\r\n  const storedPath = uni.getStorageSync(`avatar_${userId}`)\r\n  if (storedPath) {\r\n    return storedPath\r\n  }\r\n  \r\n  // 检查是否有 base64 存储（兼容旧版本）\r\n  const base64Data = uni.getStorageSync(`avatar_base64_${userId}.jpg`)\r\n  if (base64Data) {\r\n    uni.setStorageSync(`avatar_${userId}`, base64Data)\r\n    return base64Data\r\n  }\r\n  \r\n  return null\r\n}\r\n\r\n"],"names":["uni"],"mappings":";;AACY,MAAC,cAAc,MAAM;AAC/B,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtCA,kBAAAA,MAAI,YAAY;AAAA,MACd,OAAO;AAAA,MACP,UAAU,CAAC,YAAY;AAAA,MACvB,YAAY,CAAC,SAAS,QAAQ;AAAA,MAC9B,SAAS,CAAC,QAAQ;AAChB,gBAAQ,IAAI,cAAc,CAAC,CAAC;AAAA,MAC7B;AAAA,MACD,MAAM,CAAC,QAAQ;AACb,eAAO,GAAG;AAAA,MACX;AAAA,IACP,CAAK;AAAA,EACL,CAAG;AACH;AAGY,MAAC,mBAAmB,CAAC,cAAc,aAAa;AAC1D,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AAGtCA,kBAAAA,MAAI,SAAS;AAAA,MACX;AAAA,MACA,SAAS,CAAC,QAAQ;AAEhB,cAAM,gBAAgB,IAAI;AAC1B,gBAAQ,aAAa;AAAA,MACtB;AAAA,MACD,MAAM,CAAC,QAAQ;AAEb,qBAAa,cAAc,QAAQ,EAAE,KAAK,OAAO,EAAE,MAAM,MAAM;AAAA,MAChE;AAAA,IACP,CAAK;AAAA,EAOL,CAAG;AACH;AAGA,MAAM,eAAe,CAAC,cAAc,aAAa;AAC/C,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,UAAM,KAAKA,cAAG,MAAC,qBAAsB;AACrC,OAAG,SAAS;AAAA,MACV,UAAU;AAAA,MACV,UAAU;AAAA,MACV,SAAS,CAAC,QAAQ;AAChB,cAAM,aAAa,0BAA0B,IAAI,IAAI;AAErDA,sBAAG,MAAC,eAAe,iBAAiB,QAAQ,IAAI,UAAU;AAC1D,gBAAQ,UAAU;AAAA,MACnB;AAAA,MACD,MAAM,CAAC,QAAQ;AACb,eAAO,GAAG;AAAA,MACX;AAAA,IACP,CAAK;AAAA,EACL,CAAG;AACH;AAGY,MAAC,gBAAgB,CAAC,WAAW;AACvC,MAAI,CAAC;AAAQ,WAAO;AAGpB,QAAM,aAAaA,cAAAA,MAAI,eAAe,UAAU,MAAM,EAAE;AACxD,MAAI,YAAY;AACd,WAAO;AAAA,EACR;AAGD,QAAM,aAAaA,cAAAA,MAAI,eAAe,iBAAiB,MAAM,MAAM;AACnE,MAAI,YAAY;AACdA,kBAAG,MAAC,eAAe,UAAU,MAAM,IAAI,UAAU;AACjD,WAAO;AAAA,EACR;AAED,SAAO;AACT;;;;"}