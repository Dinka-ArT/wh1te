{"version":3,"file":"courses.js","sources":["pages/courses/courses.vue","../../../../../Program Files/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY291cnNlcy9jb3Vyc2VzLnZ1ZQ"],"sourcesContent":["<template>\r\n  <view class=\"container\">\r\n    <view class=\"page-header\">\r\n      <text class=\"page-title\">课程中心</text>\r\n      <text class=\"page-subtitle\">可预约的课程</text>\r\n    </view>\r\n\r\n    <view v-if=\"loading\" class=\"loading\">\r\n      <text>加载中...</text>\r\n    </view>\r\n\r\n    <view v-else-if=\"courses.length === 0\" class=\"empty\">\r\n      <text>暂无课程</text>\r\n    </view>\r\n\r\n    <scroll-view v-else scroll-y class=\"courses-list\">\r\n      <view\r\n        v-for=\"course in courses\"\r\n        :key=\"course.course_id\"\r\n        class=\"course-card\"\r\n        @click=\"showCourseDetail(course)\"\r\n      >\r\n        <view class=\"course-header\">\r\n          <text class=\"course-name\">{{ course.course_name }}</text>\r\n          <text :class=\"['status-tag', getCourseStatusType(course)]\">\r\n            {{ getCourseStatus(course) }}\r\n          </text>\r\n        </view>\r\n        <view class=\"course-info\">\r\n          <view class=\"info-item\">\r\n            <text class=\"label\">时间：</text>\r\n            <text class=\"value\">{{ formatDate(course.schedule, 'YYYY-MM-DD HH:mm') }}</text>\r\n          </view>\r\n          <view class=\"info-item\">\r\n            <text class=\"label\">教练：</text>\r\n            <text class=\"value\">{{ course.instructor_name || '待定' }}</text>\r\n          </view>\r\n          <view class=\"info-item\">\r\n            <text class=\"label\">人数：</text>\r\n            <text class=\"value\">{{ course.reserved_count || 0 }} / {{ course.capacity || 20 }} 人</text>\r\n          </view>\r\n        </view>\r\n        <view class=\"course-actions\">\r\n          <button\r\n            class=\"action-button\"\r\n            :class=\"{ disabled: !canReserve(course) && !isReserved(course) }\"\r\n            @click.stop=\"handleReserve(course)\"\r\n          >\r\n            {{ isReserved(course) ? '取消预约' : '立即预约' }}\r\n          </button>\r\n        </view>\r\n      </view>\r\n    </scroll-view>\r\n\r\n    <!-- 课程详情弹窗 -->\r\n    <view v-if=\"detailVisible\" class=\"modal\" @click=\"closeDetail\">\r\n      <view class=\"modal-content\" @click.stop>\r\n        <view class=\"modal-header\">\r\n          <text class=\"modal-title\">{{ selectedCourse?.course_name }}</text>\r\n          <text class=\"close-btn\" @click=\"closeDetail\">×</text>\r\n        </view>\r\n        <view v-if=\"selectedCourse\" class=\"modal-body\">\r\n          <view class=\"detail-item\">\r\n            <text class=\"detail-label\">开课时间：</text>\r\n            <text class=\"detail-value\">{{ formatDate(selectedCourse.schedule, 'YYYY-MM-DD HH:mm') }}</text>\r\n          </view>\r\n          <view class=\"detail-item\">\r\n            <text class=\"detail-label\">课程状态：</text>\r\n            <text :class=\"['status-tag', getCourseStatusType(selectedCourse)]\">\r\n              {{ getCourseStatus(selectedCourse) }}\r\n            </text>\r\n          </view>\r\n          <view class=\"detail-item\">\r\n            <text class=\"detail-label\">教练：</text>\r\n            <text class=\"detail-value\">{{ selectedCourse.instructor_name || '待定' }}</text>\r\n          </view>\r\n          <view class=\"detail-item\">\r\n            <text class=\"detail-label\">预约人数：</text>\r\n            <text class=\"detail-value\">{{ selectedCourse.reserved_count || 0 }} / {{ selectedCourse.capacity || 20 }}</text>\r\n          </view>\r\n          <view v-if=\"selectedCourse.description\" class=\"detail-item\">\r\n            <text class=\"detail-label\">课程介绍：</text>\r\n            <text class=\"detail-value\">{{ selectedCourse.description }}</text>\r\n          </view>\r\n        </view>\r\n        <view class=\"modal-footer\">\r\n          <button class=\"modal-button\" @click=\"closeDetail\">关闭</button>\r\n          <button\r\n            class=\"modal-button primary\"\r\n            :class=\"{ disabled: !canReserve(selectedCourse) }\"\r\n            @click=\"handleReserve(selectedCourse)\"\r\n          >\r\n            {{ isReserved(selectedCourse) ? '已预约' : '立即预约' }}\r\n          </button>\r\n        </view>\r\n      </view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport userStore from '../../store/user.js'\r\nimport { getCourses, reserveCourse } from '../../api/course.js'\r\nimport { getReservations, cancelReservation } from '../../api/reservation.js'\r\nimport { formatDate } from '../../utils/date.js'\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      courses: [],\r\n      reservations: [],\r\n      loading: false,\r\n      detailVisible: false,\r\n      selectedCourse: null\r\n    }\r\n  },\r\n  onLoad() {\r\n    // 检查登录状态\r\n    if (!userStore.getters.isLoggedIn()) {\r\n      uni.reLaunch({\r\n        url: '/pages/login/login'\r\n      })\r\n      return\r\n    }\r\n    this.loadReservations()\r\n    this.loadCourses()\r\n  },\r\n  onShow() {\r\n    if (!userStore.getters.isLoggedIn()) {\r\n      uni.reLaunch({\r\n        url: '/pages/login/login'\r\n      })\r\n      return\r\n    }\r\n    this.loadReservations()\r\n  },\r\n  methods: {\r\n    async loadReservations() {\r\n      try {\r\n        const data = await getReservations()\r\n        this.reservations = Array.isArray(data) ? data : (data.reservations || [])\r\n      } catch (error) {\r\n        console.error('获取预约列表失败:', error)\r\n      }\r\n    },\r\n    async loadCourses() {\r\n      this.loading = true\r\n      try {\r\n        const data = await getCourses()\r\n        const list = data.courses || data.list || data || []\r\n        const now = new Date()\r\n        \r\n        // 只显示未开始的课程\r\n        const allCourses = list.map(item => ({\r\n          ...item,\r\n          course_id: item.course_id ?? item.courseId,\r\n          course_name: item.course_name ?? item.courseName,\r\n          instructor_name: item.instructor_name ?? item.instructorName,\r\n          reserved_count: item.reserved_count ?? item.reservedCount\r\n        }))\r\n        \r\n        // 过滤出未开始的课程\r\n        this.courses = allCourses.filter(course => {\r\n          const courseTime = new Date(course.schedule)\r\n          return courseTime > now\r\n        })\r\n      } catch (error) {\r\n        uni.showToast({\r\n          title: '获取课程列表失败',\r\n          icon: 'none'\r\n        })\r\n      } finally {\r\n        this.loading = false\r\n      }\r\n    },\r\n    canReserve(course) {\r\n      if (!course) return false\r\n      const now = new Date()\r\n      const courseTime = new Date(course.schedule)\r\n      if (courseTime < now) return false\r\n      if (this.isReserved(course)) return false\r\n      if (course.reserved_count >= (course.capacity || 20)) return false\r\n      return true\r\n    },\r\n    isReserved(course) {\r\n      if (!course) return false\r\n      return this.reservations.some(\r\n        r => r.course_id === course.course_id && (r.status === 'pending' || r.status === 'confirmed')\r\n      )\r\n    },\r\n    getReservationForCourse(course) {\r\n      if (!course) return null\r\n      return this.reservations.find(\r\n        r => r.course_id === course.course_id && (r.status === 'pending' || r.status === 'confirmed')\r\n      )\r\n    },\r\n    getCourseStatus(course) {\r\n      if (!course) return '未知'\r\n      const now = new Date()\r\n      const courseTime = new Date(course.schedule)\r\n      if (courseTime < now) return '已结束'\r\n      const diffHours = (courseTime - now) / (1000 * 60 * 60)\r\n      if (diffHours < 1) return '即将开始'\r\n      return '未开始'\r\n    },\r\n    getCourseStatusType(course) {\r\n      const status = this.getCourseStatus(course)\r\n      if (status === '已结束') return 'info'\r\n      if (status === '即将开始') return 'warning'\r\n      return 'success'\r\n    },\r\n    showCourseDetail(course) {\r\n      this.selectedCourse = course\r\n      this.detailVisible = true\r\n    },\r\n    closeDetail() {\r\n      this.detailVisible = false\r\n      this.selectedCourse = null\r\n    },\r\n    async handleReserve(course) {\r\n      const existing = this.getReservationForCourse(course)\r\n      if (existing) {\r\n        // 取消预约\r\n        uni.showModal({\r\n          title: '取消预约',\r\n          content: `确定取消课程 \"${course.course_name}\" 的预约吗？`,\r\n          success: async (res) => {\r\n            if (res.confirm) {\r\n              try {\r\n                await cancelReservation(existing.reservation_id)\r\n                uni.showToast({\r\n                  title: '已取消预约',\r\n                  icon: 'success'\r\n                })\r\n                await this.loadReservations()\r\n                await this.loadCourses()\r\n                this.closeDetail()\r\n              } catch (error) {\r\n                uni.showToast({\r\n                  title: error.message || '取消失败',\r\n                  icon: 'none'\r\n                })\r\n              }\r\n            }\r\n          }\r\n        })\r\n        return\r\n      }\r\n\r\n      if (!this.canReserve(course)) {\r\n        uni.showToast({\r\n          title: '无法预约此课程',\r\n          icon: 'none'\r\n        })\r\n        return\r\n      }\r\n\r\n      uni.showModal({\r\n        title: '确认预约',\r\n        content: `确定要预约课程\"${course.course_name}\"吗？`,\r\n        success: async (res) => {\r\n          if (res.confirm) {\r\n            try {\r\n              await reserveCourse(course.course_id)\r\n              uni.showToast({\r\n                title: '预约成功',\r\n                icon: 'success'\r\n              })\r\n              await this.loadReservations()\r\n              await this.loadCourses()\r\n              this.closeDetail()\r\n            } catch (error) {\r\n              uni.showToast({\r\n                title: error.message || '预约失败',\r\n                icon: 'none'\r\n              })\r\n            }\r\n          }\r\n        }\r\n      })\r\n    },\r\n    formatDate\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.container {\r\n  padding: 40rpx;\r\n  background: #f5f7fa;\r\n  min-height: 100vh;\r\n}\r\n\r\n.page-header {\r\n  margin-bottom: 40rpx;\r\n}\r\n\r\n.page-title {\r\n  font-size: 48rpx;\r\n  font-weight: 600;\r\n  color: #303133;\r\n  margin-bottom: 16rpx;\r\n  display: block;\r\n}\r\n\r\n.page-subtitle {\r\n  font-size: 28rpx;\r\n  color: #909399;\r\n  display: block;\r\n}\r\n\r\n.loading,\r\n.empty {\r\n  text-align: center;\r\n  padding: 120rpx 0;\r\n  color: #909399;\r\n  font-size: 28rpx;\r\n}\r\n\r\n.courses-list {\r\n  height: calc(100vh - 240rpx);\r\n}\r\n\r\n.course-card {\r\n  background: #ffffff;\r\n  border-radius: 24rpx;\r\n  padding: 40rpx;\r\n  margin-bottom: 32rpx;\r\n  box-shadow: 0 4rpx 16rpx rgba(0, 0, 0, 0.05);\r\n}\r\n\r\n.course-header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: flex-start;\r\n  margin-bottom: 32rpx;\r\n}\r\n\r\n.course-name {\r\n  font-size: 36rpx;\r\n  font-weight: 600;\r\n  color: #303133;\r\n  flex: 1;\r\n}\r\n\r\n.status-tag {\r\n  padding: 8rpx 24rpx;\r\n  border-radius: 8rpx;\r\n  font-size: 24rpx;\r\n}\r\n\r\n.status-tag.success {\r\n  background: #f0f9ff;\r\n  color: #67c23a;\r\n}\r\n\r\n.status-tag.warning {\r\n  background: #fdf6ec;\r\n  color: #e6a23c;\r\n}\r\n\r\n.status-tag.info {\r\n  background: #f4f4f5;\r\n  color: #909399;\r\n}\r\n\r\n.course-info {\r\n  margin-bottom: 32rpx;\r\n}\r\n\r\n.info-item {\r\n  display: flex;\r\n  margin-bottom: 16rpx;\r\n  font-size: 28rpx;\r\n}\r\n\r\n.info-item:last-child {\r\n  margin-bottom: 0;\r\n}\r\n\r\n.label {\r\n  color: #909399;\r\n  margin-right: 16rpx;\r\n}\r\n\r\n.value {\r\n  color: #303133;\r\n}\r\n\r\n.action-button {\r\n  width: 100%;\r\n  height: 80rpx;\r\n  background: #667eea;\r\n  color: #ffffff;\r\n  border-radius: 16rpx;\r\n  font-size: 28rpx;\r\n  border: none;\r\n}\r\n\r\n.action-button.disabled {\r\n  background: #c0c4cc;\r\n  color: #ffffff;\r\n}\r\n\r\n.modal {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  background: rgba(0, 0, 0, 0.5);\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  z-index: 1000;\r\n}\r\n\r\n.modal-content {\r\n  width: 90%;\r\n  max-width: 600rpx;\r\n  background: #ffffff;\r\n  border-radius: 24rpx;\r\n  overflow: hidden;\r\n}\r\n\r\n.modal-header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  padding: 40rpx;\r\n  border-bottom: 1px solid #f0f0f0;\r\n}\r\n\r\n.modal-title {\r\n  font-size: 36rpx;\r\n  font-weight: 600;\r\n  color: #303133;\r\n}\r\n\r\n.close-btn {\r\n  font-size: 64rpx;\r\n  color: #909399;\r\n  line-height: 1;\r\n}\r\n\r\n.modal-body {\r\n  padding: 40rpx;\r\n  max-height: 60vh;\r\n  overflow-y: auto;\r\n}\r\n\r\n.detail-item {\r\n  margin-bottom: 32rpx;\r\n  font-size: 28rpx;\r\n}\r\n\r\n.detail-item:last-child {\r\n  margin-bottom: 0;\r\n}\r\n\r\n.detail-label {\r\n  color: #909399;\r\n  margin-right: 16rpx;\r\n}\r\n\r\n.detail-value {\r\n  color: #303133;\r\n}\r\n\r\n.modal-footer {\r\n  display: flex;\r\n  padding: 40rpx;\r\n  border-top: 1px solid #f0f0f0;\r\n  gap: 24rpx;\r\n}\r\n\r\n.modal-button {\r\n  flex: 1;\r\n  height: 80rpx;\r\n  background: #f5f7fa;\r\n  color: #303133;\r\n  border-radius: 16rpx;\r\n  font-size: 28rpx;\r\n  border: none;\r\n}\r\n\r\n.modal-button.primary {\r\n  background: #667eea;\r\n  color: #ffffff;\r\n}\r\n\r\n.modal-button.disabled {\r\n  background: #c0c4cc;\r\n  color: #ffffff;\r\n}\r\n</style>\r\n\r\n","import MiniProgramPage from 'D:/Code/Java/CloudFitness/user/cloudfit/pages/courses/courses.vue'\nwx.createPage(MiniProgramPage)"],"names":["userStore","uni","getReservations","getCourses","cancelReservation","reserveCourse","formatDate"],"mappings":"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"}